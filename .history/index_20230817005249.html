<script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
<script src="ARjavascript.js"></script>
<script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.0/aframe/build/aframe-ar.js"></script>
<script src="https://cozmo.github.io/jsQR/jsQR.js"></script>

<body style='margin : 0px; overflow: hidden;'>

  <a-scene embedded arjs='sourceType: webcam;'>

    <!-- Loading the 3D model asset -->
    <a-assets>
      <a-asset-item id="apple-model" src="https://dl.dropboxusercontent.com/scl/fi/z1ldkl00hh42wvgcidjvn/apple_ii_computer_1k.glb?rlkey=u8mw12om5h35t5rds3buf3j1u&dl=0"></a-asset-item>
    </a-assets>

    <a-marker preset='custom' type='pattern' url='https://dl.dropboxusercontent.com/scl/fi/2r32jo02nfvmfk4d83sog/pattern-qr-code-MONKEY.patt?rlkey=t1j8qwahs1193ngaihgklho50&dl=0'>
      
      <!-- Displaying the 3D model when the marker is detected -->
      <a-entity id="appleEntity" gltf-model="#apple-model" rotation="45 30 45" scale="1 1 1" material='opacity: 0.7;'>
        <a-animation attribute="rotation" to="360 45 90" dur="9000" repeat="indefinite" easing="linear"></a-animation>
      </a-entity>

      <!-- Loading text -->
      <a-text value="Loading model..." align="center" position="0 -0.5 -3" color="red" visible="false" id="loadingText"></a-text>
      
    </a-marker>
    
    <a-entity camera></a-entity>

  </a-scene>

  <script>
    try {
      canvasElement = document.createElement("canvas");
      canvasContext = canvasElement.getContext("2d");
      appleEntity = document.querySelector("#appleEntity");
      loadingText = document.querySelector("#loadingText");

      // Make the loading text visible until the model is fully loaded
      appleEntity.addEventListener('model-loaded', () => {
        loadingText.setAttribute('visible', false);
      });
      loadingText.setAttribute('visible', true);

      //scan qr code and update 3D model color
      setInterval(function() {
        video = document.querySelector("video");
        if (video && video.readyState === video.HAVE_ENOUGH_DATA) {
          canvasElement.height = video.videoHeight;
          canvasElement.width = video.videoWidth;
          canvasContext.drawImage(
            video,
            0,
            0,
            canvasElement.width,
            canvasElement.height
          );
          var imageData = canvasContext.getImageData(
            0,
            0,
            canvasElement.width,
            canvasElement.height
          );
          var qrCode = jsQR(imageData.data, imageData.width, imageData.height);
          if (qrCode && qrCode.data !== "") {
            appleEntity.setAttribute("material", "color", qrCode.data);
            console.log("QR Code Data - " + qrCode.data);
          } else {
            console.log("no qr code found");
          }
        }
      }, 3000);
    } catch (error) {
      alert(error.message);
    }
  </script>

</body>
